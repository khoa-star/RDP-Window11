name: ğŸš€ SEVER AI STV PREMIUM

on:
  workflow_dispatch:
    inputs:
      windows_version:
        description: 'Chá»n phiÃªn báº£n Windows'
        required: false
        default: '2022'
        type: choice
        options:
          - '2019'
          - '2022'
          - 'latest'
      duration:
        description: 'ğŸ• Thá»i gian sá»­ dá»¥ng'
        required: false
        default: '5h40m'
        type: choice
        options:
          - '1h'
          - '3h'
          - '5h40m'

jobs:
  Premium-RDP-Setup:
    runs-on: ${{ github.event.inputs.windows_version == '2019' && 'windows-2019' || github.event.inputs.windows_version == '2022' && 'windows-2022' || 'windows-latest' }}
    timeout-minutes: 340
    steps:
      # 1ï¸âƒ£ BANNER CHÃ€O Má»ªNG
      - name: ğŸ¯ KHá»I Äá»˜NG Há»† THá»NG
        run: |
          Write-Host "`nğŸ¤– AI STV PREMIUM RDP SERVER" -ForegroundColor Yellow
          Write-Host "âš¡ Powered by AI STV" -ForegroundColor Green
          Write-Host "ğŸ•’ Thá»i gian: ${{ github.event.inputs.duration }}" -ForegroundColor Magenta

      # 2ï¸âƒ£ Cáº¤U HÃŒNH Há»† THá»NG
      - name: ğŸ”§ Cáº¤U HÃŒNH Há»† THá»NG
        run: |
          Write-Host "ğŸ› ï¸ ÄANG Cáº¤U HÃŒNH Há»† THá»NG" -ForegroundColor Yellow
          # Báº­t Remote Desktop & táº¯t xÃ¡c thá»±c máº¡ng
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          # Má»Ÿ port 3389 firewall
          netsh advfirewall firewall add rule name="RDP-Premium" dir=in action=allow protocol=TCP localport=3389 profile=any
          netsh advfirewall firewall add rule name="RDP-Premium-Out" dir=out action=allow protocol=TCP localport=3389 profile=any
          # Khá»Ÿi Ä‘á»™ng dá»‹ch vá»¥ TermService
          Set-Service -Name TermService -StartupType Automatic -ErrorAction SilentlyContinue
          Start-Service -Name TermService -ErrorAction SilentlyContinue
          # Táº¯t táº¥t cáº£ antivirus/firewall/app & browser
          Set-MpPreference -DisableRealtimeMonitoring $true -ErrorAction SilentlyContinue
          Get-Service | Where-Object {$_.DisplayName -match "Windows Defender"} | Stop-Service -Force -ErrorAction SilentlyContinue
          Write-Host "âœ… Cáº¥u hÃ¬nh há»‡ thá»‘ng hoÃ n táº¥t!" -ForegroundColor Green

      # 3ï¸âƒ£ Táº O USER PREMIUM
      - name: ğŸ‘¤ Táº O TÃ€I KHOáº¢N PREMIUM
        run: |
          Write-Host "ğŸ‘¤ ÄANG Táº O TÃ€I KHOáº¢N PREMIUM" -ForegroundColor Yellow
          $matKhau = "AnhKhoa@123"
          $securePass = ConvertTo-SecureString $matKhau -AsPlainText -Force
          Remove-LocalUser -Name "AISTV-PREMIUM" -ErrorAction SilentlyContinue
          New-LocalUser -Name "AISTV-PREMIUM" -Password $securePass -AccountNeverExpires -Description "AI STV Premium Account"
          Set-LocalUser -Name "AISTV-PREMIUM" -PasswordNeverExpires $true -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Administrators" -Member "AISTV-PREMIUM" -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "AISTV-PREMIUM" -ErrorAction SilentlyContinue
          Enable-LocalUser -Name "AISTV-PREMIUM"
          Write-Host "âœ… TÃ i khoáº£n AISTV-PREMIUM Ä‘Ã£ sáºµn sÃ ng vá»›i máº­t kháº©u: $matKhau" -ForegroundColor Green

      # 4ï¸âƒ£ CÃ€I WINRAR NGAY SAU KHI Táº O USER
      - name: ğŸ—œï¸ CÃ€I WINRAR
        run: |
          Write-Host "ğŸ”„ Kiá»ƒm tra vÃ  cÃ i Ä‘áº·t WinRAR..." -ForegroundColor Yellow
          $winrarPath = "$env:ProgramFiles\WinRAR\WinRAR.exe"
          if (-Not (Test-Path $winrarPath)) {
            $installer = "$env:TEMP\winrar-x64.exe"
            try {
              Invoke-WebRequest -Uri "https://www.win-rar.com/fileadmin/winrar-versions/winrar/winrar-x64-713.exe" -OutFile $installer
              Start-Process -FilePath $installer -ArgumentList "/S" -Wait
              Write-Host "âœ… WinRAR Ä‘Ã£ Ä‘Æ°á»£c cÃ i Ä‘áº·t thÃ nh cÃ´ng" -ForegroundColor Green
            } catch {
              Write-Host "âš ï¸ KhÃ´ng thá»ƒ cÃ i WinRAR, bá» qua" -ForegroundColor Yellow
            } finally {
              Remove-Item $installer -ErrorAction SilentlyContinue
            }
          } else {
            Write-Host "âœ… WinRAR Ä‘Ã£ cÃ³ sáºµn trÃªn há»‡ thá»‘ng" -ForegroundColor Green
          }

      # 5ï¸âƒ£ Káº¾T Ná»I TAILSCALE & Láº¤Y IP
      - name: ğŸŒ THIáº¾T Láº¬P Máº NG PREMIUM
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          Write-Host "ğŸŒ ÄANG THIáº¾T Láº¬P Máº NG" -ForegroundColor Yellow
          $msiPath = "$env:TEMP\tailscale-premium.msi"
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msiPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$msiPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $msiPath -Force
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=ai-stv-premium-$env:GITHUB_RUN_ID --accept-routes --accept-dns --reset
          $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
          Write-Host "âœ… IP Tailscale: $ip" -ForegroundColor Green

      # 6ï¸âƒ£ HIá»‚N THá»Š THÃ”NG TIN Káº¾T Ná»I
      - name: ğŸ‰ THÃ”NG TIN Káº¾T Ná»I
        run: |
          $matKhau = "AnhKhoa@123"
          $ip = $env:TAILSCALE_IP
          Write-Host "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" -ForegroundColor Cyan
          Write-Host "â”‚ ğŸŒ IP: $ip" -ForegroundColor White
          Write-Host "â”‚ ğŸ‘¤ User: AISTV-PREMIUM" -ForegroundColor White
          Write-Host "â”‚ ğŸ” Pass: $matKhau" -ForegroundColor White
          Write-Host "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" -ForegroundColor Cyan

      # 7ï¸âƒ£ DUY TRÃŒ PHIÃŠN LÃ€M VIá»†C
      - name: â³ DUY TRÃŒ PHIÃŠN LÃ€M VIá»†C
        run: |
          $duration = "${{ github.event.inputs.duration }}"
          $minutes = switch ($duration) { "1h" {60} "3h" {180} "5h40m" {340} }
          $endTime = (Get-Date).AddMinutes($minutes)
          Write-Host "ğŸ”„ Báº¯t Ä‘áº§u duy trÃ¬ phiÃªn lÃ m viá»‡c..." -ForegroundColor Yellow
          while ((Get-Date) -lt $endTime) {
            Start-Sleep -Seconds 30
          }
          Write-Host "ğŸ¯ ÄÃ£ háº¿t thá»i gian!" -ForegroundColor Red

      # 8ï¸âƒ£ Dá»ŒN Dáº¸P Há»† THá»NG
      - name: ğŸ§¹ Dá»ŒN Dáº¸P Há»† THá»NG
        if: always()
        run: |
          Write-Host "ğŸ§¹ Dá»n dáº¹p há»‡ thá»‘ng..." -ForegroundColor Yellow
          Disable-LocalUser -Name "AISTV-PREMIUM" -ErrorAction SilentlyContinue
          netsh advfirewall firewall delete rule name="RDP-Premium" dir=in -ErrorAction SilentlyContinue
          netsh advfirewall firewall delete rule name="RDP-Premium-Out" dir=out -ErrorAction SilentlyContinue
          & "$env:ProgramFiles\Tailscale\tailscale.exe" down --accept-risk=all -ErrorAction SilentlyContinue
          Write-Host "ğŸ‰ Dá»n dáº¹p hoÃ n táº¥t!" -ForegroundColor Green
