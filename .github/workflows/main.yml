name: ğŸš€ SEVER AI STV PREMIUM

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ğŸ• Thá»i gian sá»­ dá»¥ng'
        required: false
        default: '5h40m'
        type: choice
        options:
          - '1h'
          - '3h'
          - '5h40m'

jobs:
  Premium-RDP-Setup:
    runs-on: windows-latest
    timeout-minutes: 340
    steps:
      - name: ğŸ¯ KHá»I Äá»˜NG Há»† THá»NG
        run: |
          Write-Host ""
          Write-Host "ğŸ¤– AI STV PREMIUM RDP SERVER" -ForegroundColor Yellow
          Write-Host "âš¡ Powered by AI STV" -ForegroundColor Green
          Write-Host "ğŸ•’ Thá»i gian: ${{ github.event.inputs.duration }}" -ForegroundColor Magenta
          Write-Host ""
          $frames = @('â£¾','â£½','â£»','â¢¿','â¡¿','â£Ÿ','â£¯','â£·')
          for($i=0;$i -lt 10;$i++){
            Write-Host "`rğŸš€ Äang khá»Ÿi táº¡o há»‡ thá»‘ng... $($frames[$i % 8])" -NoNewline -ForegroundColor Blue
            Start-Sleep -Milliseconds 100
          }
          Write-Host "`râœ… Há»‡ thá»‘ng Ä‘Ã£ sáºµn sÃ ng!" -ForegroundColor Green

      - name: ğŸ”§ Cáº¤U HÃŒNH Há»† THá»NG
        run: |
          Write-Host ""
          Write-Host "ğŸ› ï¸ ÄANG Cáº¤U HÃŒNH Há»† THá»NG" -ForegroundColor Yellow

          # Báº­t RDP vÃ  táº¯t xÃ¡c thá»±c máº¡ng
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force

          # Má»Ÿ port 3389
          netsh advfirewall firewall add rule name="RDP-Premium" dir=in action=allow protocol=TCP localport=3389 profile=any
          netsh advfirewall firewall add rule name="RDP-Premium-Out" dir=out action=allow protocol=TCP localport=3389 profile=any

          # Khá»Ÿi Ä‘á»™ng dá»‹ch vá»¥ RDP
          Set-Service -Name TermService -StartupType Automatic
          Set-Service -Name UmRdpService -StartupType Automatic
          Start-Service -Name TermService
          Start-Service -Name UmRdpService

          Write-Host "ğŸ¯ Cáº¥u hÃ¬nh hoÃ n táº¥t!" -ForegroundColor Green

      - name: ğŸ‘¤ Táº O TÃ€I KHOáº¢N PREMIUM
        run: |
          Write-Host ""
          Write-Host "ğŸ‘¤ ÄANG Táº O TÃ€I KHOáº¢N PREMIUM" -ForegroundColor Yellow

          $matKhau = "AnhKhoa@123"
          $securePass = ConvertTo-SecureString $matKhau -AsPlainText -Force

          try { Remove-LocalUser -Name "AISTV-PREMIUM" -ErrorAction SilentlyContinue } catch {}
          New-LocalUser -Name "AISTV-PREMIUM" -Password $securePass -AccountNeverExpires -Description "AI STV Premium Account"
          Set-LocalUser -Name "AISTV-PREMIUM" -PasswordNeverExpires $true
          Add-LocalGroupMember -Group "Administrators" -Member "AISTV-PREMIUM"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "AISTV-PREMIUM"
          Enable-LocalUser -Name "AISTV-PREMIUM"

          echo "RDP_USER=AISTV-PREMIUM" >> $env:GITHUB_ENV
          echo "RDP_PASS=$matKhau" >> $env:GITHUB_ENV
          echo "$matKhau" > $env:TEMP\rdp_password.txt

          Write-Host "âœ… TÃ i khoáº£n: AISTV-PREMIUM Ä‘Ã£ sáºµn sÃ ng" -ForegroundColor Green

      - name: ğŸ” KIá»‚M TRA Há»† THá»NG
        run: |
          Write-Host ""
          Write-Host "ğŸ” KIá»‚M TRA QUYá»€N Há»† THá»NG" -ForegroundColor Yellow
          $user = Get-LocalUser -Name "AISTV-PREMIUM"
          if ($user) { Write-Host "â”‚ âœ… User tá»“n táº¡i: $($user.Name)" -ForegroundColor Green }

          $isAdmin = (Get-LocalGroupMember -Group "Administrators" | Where-Object {$_.Name -like "*AISTV-PREMIUM"}).Count -gt 0
          if ($isAdmin) { Write-Host "â”‚ âœ… CÃ³ quyá»n Administrator" -ForegroundColor Green }

          $isRDPUser = (Get-LocalGroupMember -Group "Remote Desktop Users" | Where-Object {$_.Name -like "*AISTV-PREMIUM"}).Count -gt 0
          if ($isRDPUser) { Write-Host "â”‚ âœ… CÃ³ quyá»n Remote Desktop" -ForegroundColor Green }

          $termService = Get-Service -Name TermService
          if ($termService.Status -eq 'Running') { Write-Host "â”‚ âœ… Dá»‹ch vá»¥ TermService Ä‘ang cháº¡y" -ForegroundColor Green }

      - name: ğŸŒ THIáº¾T Láº¬P Máº NG PREMIUM
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          Write-Host ""
          Write-Host "ğŸŒ ÄANG THIáº¾T Láº¬P Káº¾T Ná»I Máº NG" -ForegroundColor Yellow

          $msiPath = "$env:TEMP\tailscale-premium.msi"
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msiPath
          Start-Process msiexec.exe -ArgumentList "/i","`"$msiPath`"","/quiet","/norestart" -Wait
          Remove-Item $msiPath -Force

          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=ai-stv-premium-$env:GITHUB_RUN_ID --accept-routes --accept-dns --reset

          $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV

      - name: ğŸ‰ HIá»‚N THá»Š THÃ”NG TIN Káº¾T Ná»I
        run: |
          $matKhau = Get-Content $env:TEMP\rdp_password.txt
          $ip = $env:TAILSCALE_IP

          Write-Host ""
          Write-Host "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" -ForegroundColor Cyan
          Write-Host "â”‚ ğŸŒ IP: _______ $ip _______ â”‚" -ForegroundColor White
          Write-Host "â”‚ ğŸ‘¤ User: _______ AISTV-PREMIUM _______ â”‚" -ForegroundColor White
          Write-Host "â”‚ ğŸ” Pass: _______ $matKhau _______ â”‚" -ForegroundColor White
          Write-Host "â”‚ ğŸ“ Port: 3389 â”‚" -ForegroundColor White
          Write-Host "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" -ForegroundColor Cyan

      - name: â³ DUY TRÃŒ PHIÃŠN LÃ€M VIá»†C
        run: |
          $totalMinutes = switch ("${{ github.event.inputs.duration }}") {
            "1h" { 60 }
            "3h" { 180 }
            "5h40m" { 340 }
          }
          $timeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
          $thoiGianBatDau = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
          $thoiGianKetThuc = $thoiGianBatDau.AddMinutes($totalMinutes)

          Write-Host "ğŸ”„ Duy trÃ¬ phiÃªn RDP Ä‘áº¿n $($thoiGianKetThuc.ToString('HH:mm:ss'))" -ForegroundColor Yellow
          Start-Sleep -Seconds ($totalMinutes*60)

      - name: ğŸ§¹ Dá»ŒN Dáº¸P Há»† THá»NG
        if: always()
        run: |
          Write-Host "ğŸ§¹ ÄANG Dá»ŒN Dáº¸P..."
          Remove-Item "$env:TEMP\rdp_password.txt" -ErrorAction SilentlyContinue
          Disable-LocalUser -Name "AISTV-PREMIUM" -ErrorAction SilentlyContinue
          & "$env:ProgramFiles\Tailscale\tailscale.exe" down --accept-risk=all -ErrorAction SilentlyContinue
          netsh advfirewall firewall delete rule name="RDP-Premium" dir=in -ErrorAction SilentlyContinue
          netsh advfirewall firewall delete rule name="RDP-Premium-Out" dir=out -ErrorAction SilentlyContinue
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 1 -Force
          Stop-Service -Name TermService -Force
          Write-Host "ğŸ‰ Dá»n dáº¹p hoÃ n táº¥t!"
