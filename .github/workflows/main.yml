name: ğŸš€ SEVER AI STV PREMIUM

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ğŸ• Thá»i gian sá»­ dá»¥ng'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h'
        - '5h40m'

jobs:
  Premium-RDP-Setup:
    runs-on: windows-latest
    timeout-minutes: 340
    steps:

    # ------------------------------
    # BANNER CHÃ€O Má»ªNG
    # ------------------------------
    - name: ğŸ¯ KHá»I Äá»˜NG Há»† THá»NG
      run: |
        Write-Host ""
        Write-Host "ğŸ¤– AI STV PREMIUM RDP SERVER" -ForegroundColor Yellow
        Write-Host "âš¡ Powered by AI STV" -ForegroundColor Green
        Write-Host "ğŸ•’ Thá»i gian: ${{ github.event.inputs.duration }}" -ForegroundColor Magenta
        Write-Host ""

        # Hiá»‡u á»©ng loading
        $frames = @('â£¾','â£½','â£»','â¢¿','â¡¿','â£Ÿ','â£¯','â£·')
        for($i=0; $i -lt 10; $i++){
          Write-Host "`rğŸš€ Äang khá»Ÿi táº¡o há»‡ thá»‘ng... $($frames[$i % 8])" -NoNewline -ForegroundColor Blue
          Start-Sleep -Milliseconds 100
        }
        Write-Host "`râœ… Há»‡ thá»‘ng Ä‘Ã£ sáºµn sÃ ng!" -ForegroundColor Green

    # ------------------------------
    # Lá»°A CHá»ŒN SERVER + CÃ€I WINRAR
    # ------------------------------
    - name: ğŸ–¥ï¸ CHá»ŒN SERVER VÃ€ CÃ€I WINRAR
      run: |
        Write-Host ""
        Write-Host "ğŸ–¥ï¸ Lá»°A CHá»ŒN SERVER" -ForegroundColor Yellow
        $serverVersion = "2022"
        Write-Host "â”‚ âœ… Server máº·c Ä‘á»‹nh: Windows Server $serverVersion" -ForegroundColor Green

        # Kiá»ƒm tra WinRAR
        $winrarPath = "C:\Program Files\WinRAR\WinRAR.exe"
        if (-Not (Test-Path $winrarPath)) {
            Write-Host "â”‚ ğŸ”„ WinRAR chÆ°a cÃ i, Ä‘ang cÃ i..." -ForegroundColor Yellow
            $exeUrl = "https://www.rarlab.com/rar/winrar-x64-611.exe"
            $exePath = "$env:TEMP\winrar-installer.exe"
            Invoke-WebRequest -Uri $exeUrl -OutFile $exePath
            Start-Process -FilePath $exePath -ArgumentList "/S" -Wait
            Remove-Item $exePath -Force
            Write-Host "â”‚ âœ… WinRAR Ä‘Ã£ cÃ i xong" -ForegroundColor Green
        } else {
            Write-Host "â”‚ âœ… WinRAR Ä‘Ã£ tá»“n táº¡i" -ForegroundColor Green
        }

        # Set WinRAR máº·c Ä‘á»‹nh má»Ÿ file .rar
        Write-Host "â”‚ ğŸ”§ Äáº·t WinRAR lÃ m máº·c Ä‘á»‹nh cho .rar" -ForegroundColor Yellow
        New-ItemProperty -Path "HKCU:\Software\Classes\.rar" -Name "(Default)" -Value "WinRAR" -Force
        New-ItemProperty -Path "HKCU:\Software\Classes\WinRAR\shell\open\command" -Name "(Default)" -Value "`"$winrarPath`" `%1" -Force
        Write-Host "â”‚ âœ… WinRAR Ä‘Ã£ set máº·c Ä‘á»‹nh cho .rar" -ForegroundColor Green

    # ------------------------------
    # Cáº¤U HÃŒNH Há»† THá»NG
    # ------------------------------
    - name: ğŸ”§ Cáº¤U HÃŒNH Há»† THá»NG
      run: |
        Write-Host ""
        Write-Host "ğŸ› ï¸ ÄANG Cáº¤U HÃŒNH Há»† THá»NG" -ForegroundColor Yellow
        $steps=@(
          @{Name="Báº­t Remote Desktop"; Script={Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force}},
          @{Name="Táº¯t xÃ¡c thá»±c máº¡ng"; Script={Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force}},
          @{Name="Cáº¥u hÃ¬nh báº£o máº­t RDP"; Script={Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force}},
          @{Name="Má»Ÿ port 3389 firewall"; Script={netsh advfirewall firewall add rule name="RDP-Premium" dir=in action=allow protocol=TCP localport=3389 profile=any
                                                   netsh advfirewall firewall add rule name="RDP-Premium-Out" dir=out action=allow protocol=TCP localport=3389 profile=any}},
          @{Name="Khá»Ÿi Ä‘á»™ng dá»‹ch vá»¥"; Script={Set-Service -Name TermService -StartupType Automatic -ErrorAction SilentlyContinue
                                               Set-Service -Name UmRdpService -StartupType Automatic -ErrorAction SilentlyContinue
                                               Start-Service -Name TermService -ErrorAction SilentlyContinue
                                               Start-Service -Name UmRdpService -ErrorAction SilentlyContinue}}
        )
        foreach($step in $steps){
          Write-Host "â”‚ ğŸ“‹ $($step.Name)..." -NoNewline -ForegroundColor White
          try { & $step.Script; Write-Host "`râ”‚ âœ… $($step.Name)" -ForegroundColor Green }
          catch { Write-Host "`râ”‚ âš ï¸ $($step.Name) - ÄÃ£ bá» qua lá»—i nhá»" -ForegroundColor Yellow }
          Start-Sleep -Milliseconds 500
        }
        Write-Host "ğŸ¯ Cáº¥u hÃ¬nh hoÃ n táº¥t!" -ForegroundColor Green

    # ------------------------------
    # Táº O USER PREMIUM
    # ------------------------------
    - name: ğŸ‘¤ Táº O TÃ€I KHOáº¢N PREMIUM
      run: |
        Write-Host ""
        Write-Host "ğŸ‘¤ ÄANG Táº O TÃ€I KHOáº¢N PREMIUM" -ForegroundColor Yellow
        $matKhau = "AnhKhoa@123"
        $securePass = ConvertTo-SecureString $matKhau -AsPlainText -Force
        try { Remove-LocalUser -Name "AISTV-PREMIUM" -ErrorAction SilentlyContinue; Write-Host "â”‚ âœ… ÄÃ£ xÃ³a user cÅ©" -ForegroundColor Green } catch {}
        try {
          New-LocalUser -Name "AISTV-PREMIUM" -Password $securePass -AccountNeverExpires -Description "AI STV Premium Account"
          Add-LocalGroupMember -Group "Administrators" -Member "AISTV-PREMIUM" -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "AISTV-PREMIUM" -ErrorAction SilentlyContinue
          Enable-LocalUser -Name "AISTV-PREMIUM"
          Write-Host "â”‚ âœ… TÃ i khoáº£n AISTV-PREMIUM Ä‘Ã£ sáºµn sÃ ng" -ForegroundColor Green
        } catch { Write-Host "â”‚ âŒ Lá»—i táº¡o user: $($_.Exception.Message)" -ForegroundColor Red; exit 1 }
        echo "RDP_USER=AISTV-PREMIUM" >> $env:GITHUB_ENV
        echo "RDP_PASS=$matKhau" >> $env:GITHUB_ENV

    # ------------------------------
    # HIá»‚N THá»Š IP / PASS / PORT Báº°NG Ã” ________
    # ------------------------------
    - name: ğŸ‰ HIá»‚N THá»Š THÃ”NG TIN Káº¾T Ná»I
      run: |
        Write-Host ""
        $ip = "__________"  # sau nÃ y thay báº±ng Tailscale IP
        $pass = $matKhau
        Write-Host "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" -ForegroundColor Cyan
        Write-Host "â”‚ ğŸŒ IP:       $ip" -ForegroundColor White
        Write-Host "â”‚ ğŸ‘¤ User:     AISTV-PREMIUM" -ForegroundColor White
        Write-Host "â”‚ ğŸ” Pass:     $pass" -ForegroundColor White
        Write-Host "â”‚ ğŸ“ Port:     3389" -ForegroundColor White
        Write-Host "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" -ForegroundColor Cyan

    # ------------------------------
    # DUY TRÃŒ PHIÃŠN LÃ€M VIá»†C + MONITOR
    # ------------------------------
    - name: â³ DUY TRÃŒ PHIÃŠN LÃ€M VIá»†C
      run: |
        Write-Host ""
        $totalMinutes = 340
        $timeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
        $thoiGianBatDau = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
        $thoiGianKetThuc = $thoiGianBatDau.AddMinutes($totalMinutes)
        Write-Host "ğŸ”„ Báº®T Äáº¦U DUY TRÃŒ PHIÃŠN LÃ€M VIá»†C..." -ForegroundColor Yellow

        $monitorScript = {
          while($true){
            $termService = Get-Service -Name TermService -ErrorAction SilentlyContinue
            $rdpConnections = Get-NetTCPConnection -LocalPort 3389 -ErrorAction SilentlyContinue | Where-Object {$_.State -eq 'Established'}
            Write-Host "ğŸ“Š RDP: $($termService.Status), Káº¿t ná»‘i: $($rdpConnections.Count)" -ForegroundColor Blue
            if($termService.Status -ne 'Running'){ Start-Service TermService -ErrorAction SilentlyContinue }
            Start-Sleep -Seconds 30
          }
        }
        Start-Job -ScriptBlock $monitorScript -Name "SystemMonitor"

    # ------------------------------
    # Dá»ŒN Dáº¸P CUá»I
    # ------------------------------
    - name: ğŸ§¹ Dá»ŒN Dáº¸P Há»† THá»NG
      if: always()
      run: |
        Write-Host ""
        Write-Host "ğŸ§¹ ÄANG Dá»ŒN Dáº¸P Há»† THá»NG..." -ForegroundColor Yellow
        try { Disable-LocalUser -Name "AISTV-PREMIUM" -ErrorAction SilentlyContinue } catch {}
        try { Remove-Item "$env:TEMP\rdp_password.txt" -ErrorAction SilentlyContinue } catch {}
        try { Stop-Job -Name "SystemMonitor" -Force -ErrorAction SilentlyContinue } catch {}
        Write-Host "ğŸ‰ Dá»n dáº¹p hoÃ n táº¥t! ğŸ‘‹" -ForegroundColor Green
