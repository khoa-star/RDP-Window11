name: üöÄ SEVER AI STV PREMIUM

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'üïê Th·ªùi gian s·ª≠ d·ª•ng'
        required: false
        default: '5h40m'
        type: choice
        options:
          - '1h'
          - '3h'
          - '5h40m'
      server_version:
        description: 'Ch·ªçn phi√™n b·∫£n Windows Server'
        required: false
        default: '2022'
        type: choice
        options:
          - '2019'
          - '2022'
          - 'latest'

jobs:
  Premium-RDP-Setup:
    runs-on: windows-2022
    timeout-minutes: 340
    steps:
      - name: üéØ KH·ªûI ƒê·ªòNG H·ªÜ TH·ªêNG
        run: |
          Write-Host "ü§ñ AI STV PREMIUM RDP SERVER" -ForegroundColor Yellow
          Write-Host "‚ö° Powered by AI STV" -ForegroundColor Green
          Write-Host "üïí Th·ªùi gian: ${{ github.event.inputs.duration }}" -ForegroundColor Magenta

      - name: üîß C·∫§U H√åNH H·ªÜ TH·ªêNG
        run: |
          Write-Host "üõ†Ô∏è ƒêANG C·∫§U H√åNH H·ªÜ TH·ªêNG" -ForegroundColor Yellow
          # B·∫≠t Remote Desktop
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          # T·∫Øt x√°c th·ª±c m·∫°ng
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          # C·∫•u h√¨nh b·∫£o m·∫≠t RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          # M·ªü port 3389
          netsh advfirewall firewall add rule name="RDP-Premium" dir=in action=allow protocol=TCP localport=3389 profile=any
          netsh advfirewall firewall add rule name="RDP-Premium-Out" dir=out action=allow protocol=TCP localport=3389 profile=any
          # Kh·ªüi ƒë·ªông d·ªãch v·ª•
          Set-Service -Name TermService -StartupType Automatic -ErrorAction SilentlyContinue
          Set-Service -Name UmRdpService -StartupType Automatic -ErrorAction SilentlyContinue
          Start-Service -Name TermService -ErrorAction SilentlyContinue
          Start-Service -Name UmRdpService -ErrorAction SilentlyContinue

      - name: üë§ T·∫†O T√ÄI KHO·∫¢N PREMIUM
        run: |
          Write-Host "üë§ ƒêANG T·∫†O T√ÄI KHO·∫¢N PREMIUM" -ForegroundColor Yellow
          $matKhau = "AnhKhoa@123"
          $securePass = ConvertTo-SecureString $matKhau -AsPlainText -Force
          try { Remove-LocalUser -Name "AISTV-PREMIUM" -ErrorAction SilentlyContinue } catch {}
          New-LocalUser -Name "AISTV-PREMIUM" -Password $securePass -AccountNeverExpires -Description "AI STV Premium Account"
          Set-LocalUser -Name "AISTV-PREMIUM" -PasswordNeverExpires $true -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Administrators" -Member "AISTV-PREMIUM" -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "AISTV-PREMIUM" -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Users" -Member "AISTV-PREMIUM" -ErrorAction SilentlyContinue
          Enable-LocalUser -Name "AISTV-PREMIUM"
          echo "RDP_USER=AISTV-PREMIUM" >> $env:GITHUB_ENV
          echo "RDP_PASS=$matKhau" >> $env:GITHUB_ENV
          Write-Host "‚úÖ T√†i kho·∫£n: AISTV-PREMIUM ƒë√£ s·∫µn s√†ng" -ForegroundColor Green

      - name: üóúÔ∏è C√ÄI WINRAR V√Ä T·∫¢I FILE
        run: |
          Write-Host "üîÑ C√†i ƒë·∫∑t WinRAR n·∫øu ch∆∞a c√≥..." -ForegroundColor Yellow
          $winrarPath = "$env:ProgramFiles\WinRAR\WinRAR.exe"
          if (-Not (Test-Path $winrarPath)) {
            $installer = "$env:TEMP\winrar-x64.exe"
            try {
              Invoke-WebRequest -Uri "https://www.win-rar.com/fileadmin/winrar-versions/winrar/winrar-x64-713.exe" -OutFile $installer
              Start-Process -FilePath $installer -ArgumentList "/S" -Wait
              Write-Host "‚úÖ WinRAR ƒë√£ c√†i xong" -ForegroundColor Green
            } catch {
              Write-Host "‚ö†Ô∏è Kh√¥ng th·ªÉ c√†i WinRAR, b·ªè qua" -ForegroundColor Yellow
            } finally {
              Remove-Item $installer -ErrorAction SilentlyContinue
            }
          } else {
            Write-Host "‚úÖ WinRAR ƒë√£ c√≥ s·∫µn" -ForegroundColor Green
          }

          try {
            Write-Host "üîß Set WinRAR l√†m app m·∫∑c ƒë·ªãnh cho .rar..." -ForegroundColor Cyan
            Start-Process -FilePath "$winrarPath" -ArgumentList "/reg" -Wait
            Write-Host "‚úÖ WinRAR ƒë√£ ƒë∆∞·ª£c set l√†m m·∫∑c ƒë·ªãnh" -ForegroundColor Green
          } catch {
            Write-Host "‚ö†Ô∏è Kh√¥ng th·ªÉ set WinRAR l√†m m·∫∑c ƒë·ªãnh, b·ªè qua" -ForegroundColor Yellow
          }

          try {
            $downloads = [Environment]::GetFolderPath("UserProfile") + "\Downloads"
            $fileUrl = "https://drive.usercontent.google.com/download?id=1XKZzk-0fyGLyeuDDoUHL54AiK-ryUZmV&export=download&authuser=0"
            $output = "$downloads\downloaded_file"
            Invoke-WebRequest -Uri $fileUrl -OutFile $output -ErrorAction Stop
            Write-Host "‚úÖ File ƒë√£ ƒë∆∞·ª£c t·∫£i v·ªÅ: $output" -ForegroundColor Green
          } catch {
            Write-Host "‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫£i file t·ª´ Google Drive, b·ªè qua" -ForegroundColor Yellow
          }

      - name: ‚è≥ DUY TR√å PHI√äN L√ÄM VI·ªÜC
        run: |
          Write-Host "üîÑ B·∫ÆT ƒê·∫¶U DUY TR√å PHI√äN L√ÄM VI·ªÜC..." -ForegroundColor Yellow
          # Gi·ªØ k·∫øt n·ªëi RDP, ki·ªÉm tra d·ªãch v·ª• TermService
          $lastLogTime = Get-Date
          while ($true) {
            $termService = Get-Service -Name TermService -ErrorAction SilentlyContinue
            if ($termService.Status -ne 'Running') { Start-Service -Name TermService -ErrorAction SilentlyContinue }
            Start-Sleep -Seconds 30
          }

      - name: üßπ D·ªåN D·∫∏P H·ªÜ TH·ªêNG
        if: always()
        run: |
          Write-Host "üßπ ƒêANG D·ªåN D·∫∏P H·ªÜ TH·ªêNG..." -ForegroundColor Yellow
          Remove-Item "$env:TEMP\rdp_password.txt" -ErrorAction SilentlyContinue
          Disable-LocalUser -Name "AISTV-PREMIUM" -ErrorAction SilentlyContinue
          try { & "$env:ProgramFiles\Tailscale\tailscale.exe" down --accept-risk=all } catch {}
          netsh advfirewall firewall delete rule name="RDP-Premium" dir=in -ErrorAction SilentlyContinue
          netsh advfirewall firewall delete rule name="RDP-Premium-Out" dir=out -ErrorAction SilentlyContinue
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 1 -Force
          Stop-Service -Name TermService -Force -ErrorAction SilentlyContinue
