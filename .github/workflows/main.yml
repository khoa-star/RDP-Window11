name: ğŸš€ SEVER AI STV PREMIUM

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ğŸ• Thá»i gian sá»­ dá»¥ng'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h'
        - '5h40m'
      windows_version:
        description: 'ğŸ’» Chá»n phiÃªn báº£n Windows Server'
        required: false
        default: '2022'
        type: choice
        options:
        - '2019'
        - '2022'
        - 'latest'

jobs:
  Premium-RDP-Setup:
    runs-on: ${{ github.event.inputs.windows_version == 'latest' && 'windows-latest' || github.event.inputs.windows_version == '2022' && 'windows-2022' || 'windows-2019' }}
    timeout-minutes: 340
    steps:

    # BANNER
    - name: ğŸ¯ KHá»I Äá»˜NG Há»† THá»NG
      run: |
        Write-Host ""
        Write-Host "ğŸ¤– AI STV PREMIUM RDP SERVER" -ForegroundColor Yellow
        Write-Host "âš¡ Powered by AI STV" -ForegroundColor Green
        Write-Host "ğŸ•’ Thá»i gian: ${{ github.event.inputs.duration }}" -ForegroundColor Magenta
        $frames = @('â£¾','â£½','â£»','â¢¿','â¡¿','â£Ÿ','â£¯','â£·')
        for($i=0;$i -lt 10;$i++){
          Write-Host "`rğŸš€ Äang khá»Ÿi táº¡o há»‡ thá»‘ng... $($frames[$i % 8])" -NoNewline -ForegroundColor Blue
          Start-Sleep -Milliseconds 100
        }
        Write-Host "`râœ… Há»‡ thá»‘ng Ä‘Ã£ sáºµn sÃ ng!" -ForegroundColor Green

    # Cáº¤U HÃŒNH Há»† THá»NG
    - name: ğŸ”§ Cáº¤U HÃŒNH Há»† THá»NG
      run: |
        Write-Host "ğŸ› ï¸ ÄANG Cáº¤U HÃŒNH Há»† THá»NG" -ForegroundColor Yellow
        # Báº­t Remote Desktop
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
        # Táº¯t xÃ¡c thá»±c máº¡ng
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
        # Cáº¥u hÃ¬nh báº£o máº­t RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
        # Táº¯t firewall
        netsh advfirewall set allprofiles state off
        # Táº¯t Windows Defender
        Set-MpPreference -DisableRealtimeMonitoring $true -ErrorAction SilentlyContinue
        # Táº¯t UAC
        Set-ItemProperty -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System' -Name "EnableLUA" -Value 0 -Force

    # Táº O USER PREMIUM
    - name: ğŸ‘¤ Táº O TÃ€I KHOáº¢N PREMIUM
      run: |
        Write-Host "ğŸ‘¤ ÄANG Táº O TÃ€I KHOáº¢N PREMIUM" -ForegroundColor Yellow
        $matKhau = "AnhKhoa@123"
        $securePass = ConvertTo-SecureString $matKhau -AsPlainText -Force
        # XÃ³a user cÅ© náº¿u tá»“n táº¡i
        Remove-LocalUser -Name "AISTV-PREMIUM" -ErrorAction SilentlyContinue
        # Táº¡o user má»›i
        New-LocalUser -Name "AISTV-PREMIUM" -Password $securePass -AccountNeverExpires -Description "AI STV Premium Account"
        Set-LocalUser -Name "AISTV-PREMIUM" -PasswordNeverExpires $true
        Add-LocalGroupMember -Group "Administrators" -Member "AISTV-PREMIUM" -ErrorAction SilentlyContinue
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "AISTV-PREMIUM" -ErrorAction SilentlyContinue
        Enable-LocalUser -Name "AISTV-PREMIUM"
        echo "RDP_USER=AISTV-PREMIUM" >> $env:GITHUB_ENV
        echo "RDP_PASS=$matKhau" >> $env:GITHUB_ENV
        Write-Host "âœ… TÃ i khoáº£n: AISTV-PREMIUM Ä‘Ã£ sáºµn sÃ ng" -ForegroundColor Green

    # CÃ€I WINRAR
    - name: ğŸ“¦ CÃ€I WINRAR
      run: |
        Write-Host "ğŸ”„ Kiá»ƒm tra WinRAR..." -ForegroundColor Yellow
        $winrarPath = "$env:ProgramFiles\WinRAR\WinRAR.exe"
        if (-Not (Test-Path $winrarPath)) {
          Write-Host "ğŸ”„ WinRAR chÆ°a cÃ i, Ä‘ang cÃ i..." -ForegroundColor Yellow
          try {
            $exePath = "$env:TEMP\winrar-x64-713.exe"
            Invoke-WebRequest -Uri "https://www.win-rar.com/fileadmin/winrar-versions/winrar/winrar-x64-713.exe" -OutFile $exePath -UseBasicParsing
            Start-Process -FilePath $exePath -ArgumentList "/S" -Wait -ErrorAction Stop
            Write-Host "âœ… WinRAR Ä‘Ã£ cÃ i Ä‘áº·t thÃ nh cÃ´ng" -ForegroundColor Green
          } catch {
            Write-Host "âš ï¸ KhÃ´ng thá»ƒ cÃ i WinRAR, bá» qua" -ForegroundColor Yellow
          }
        } else {
          Write-Host "âœ… WinRAR Ä‘Ã£ tá»“n táº¡i" -ForegroundColor Green
        }

    # TAILSCALE
    - name: ğŸŒ THIáº¾T Láº¬P Máº NG PREMIUM
      env:
        TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
        Write-Host "ğŸŒ ÄANG THIáº¾T Láº¬P Káº¾T Ná»I Máº NG" -ForegroundColor Yellow
        try {
          $msiPath = "$env:TEMP\tailscale-premium.msi"
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msiPath
          Start-Process msiexec.exe -ArgumentList "/i","`"$msiPath`"","/quiet","/norestart" -Wait
          Remove-Item $msiPath -Force
          Write-Host "âœ… CÃ i Ä‘áº·t Tailscale thÃ nh cÃ´ng" -ForegroundColor Green
        } catch {
          Write-Host "âš ï¸ Lá»—i cÃ i Ä‘áº·t Tailscale, bá» qua" -ForegroundColor Yellow
        }
        Start-Sleep -Seconds 10
        try {
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=ai-stv-premium-$env:GITHUB_RUN_ID --accept-routes --accept-dns --reset
          Write-Host "âœ… Káº¿t ná»‘i Tailscale thÃ nh cÃ´ng" -ForegroundColor Green
        } catch {
          Write-Host "âš ï¸ Lá»—i káº¿t ná»‘i Tailscale, bá» qua" -ForegroundColor Yellow
        }
        # Láº¥y IP
        Write-Host "ğŸ”„ Äang láº¥y Ä‘á»‹a chá»‰ IP..." -NoNewline -ForegroundColor Blue
        $ip = $null
        for($i=0;$i -lt 20;$i++){
          try {
            $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>&1
            if ($ip -and $ip -match '^\d+\.\d+\.\d+\.\d+$') {
              echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
              Write-Host "`râœ… Äá»‹a chá»‰ IP: $ip" -ForegroundColor Green
              break
            }
          } catch {}
          Write-Host "`rğŸ”„ Äang láº¥y Ä‘á»‹a chá»‰ IP... $(@('.', '..', '...')[$i % 3])" -NoNewline -ForegroundColor Blue
          Start-Sleep -Seconds 3
        }
        if (-not $ip -or $ip -notmatch '^\d+\.\d+\.\d+\.\d+$') {
          Write-Host "`râš ï¸ KhÃ´ng thá»ƒ láº¥y IP, sá»­ dá»¥ng localhost" -ForegroundColor Yellow
          echo "TAILSCALE_IP=localhost" >> $env:GITHUB_ENV
        }

    # HIá»‚N THá»Š THÃ”NG TIN Káº¾T Ná»I
    - name: ğŸ‰ THÃ”NG TIN Káº¾T Ná»I
      run: |
        $matKhau = "AnhKhoa@123"
        $user = "AISTV-PREMIUM"
        $ip = $env:TAILSCALE_IP
        $displayTime = "${{ github.event.inputs.duration }}"
        Write-Host ""
        Write-Host "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" -ForegroundColor Cyan
        Write-Host "â”‚ ğŸŒ IP: $ip" -ForegroundColor White
        Write-Host "â”‚ ğŸ‘¤ User: $user" -ForegroundColor White
        Write-Host "â”‚ ğŸ” Pass: $matKhau" -ForegroundColor White
        Write-Host "â”‚ â° Thá»i lÆ°á»£ng: $displayTime" -ForegroundColor White
        Write-Host "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" -ForegroundColor Cyan

    # DUY TRÃŒ PHIÃŠN
    - name: â³ DUY TRÃŒ PHIÃŠN LÃ€M VIá»†C
      run: |
        $totalMinutes = ${{ github.event.inputs.duration -replace '[^0-9]', '' }}
        $timeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
        $thoiGianBatDau = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
        $thoiGianKetThuc = $thoiGianBatDau.AddMinutes([int]$totalMinutes)
        Write-Host "ğŸ”„ DUY TRÃŒ PHIÃŠN LÃ€M VIá»†C..." -ForegroundColor Yellow
        $monitorScript = {
          while($true){
            $termService = Get-Service -Name TermService -ErrorAction SilentlyContinue
            if ($termService.Status -ne 'Running'){ Start-Service TermService -ErrorAction SilentlyContinue }
            Start-Sleep -Seconds 30
          }
        }
        Start-Job -ScriptBlock $monitorScript -Name "SystemMonitor"

    # Dá»ŒN Dáº¸P
    - name: ğŸ§¹ Dá»ŒN Dáº¸P Há»† THá»NG
      if: always()
      run: |
        Write-Host "ğŸ§¹ ÄANG Dá»ŒN Dáº¸P Há»† THá»NG..." -ForegroundColor Yellow
        Disable-LocalUser -Name "AISTV-PREMIUM" -ErrorAction SilentlyContinue
        & "$env:ProgramFiles\Tailscale\tailscale.exe" down --accept-risk=all -ErrorAction SilentlyContinue
        netsh advfirewall set allprofiles state on
        Get-Job | Stop-Job -PassThru | Remove-Job -Force -ErrorAction SilentlyContinue
        Write-Host "ğŸ‰ Dá»n dáº¹p hoÃ n táº¥t! ğŸ‘‹" -ForegroundColor Green
