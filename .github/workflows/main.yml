name: ğŸš€ SEVER AI STV PREMIUM

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ğŸ• Thá»i gian sá»­ dá»¥ng'
        required: false
        default: '5h40m'
        type: choice
        options:
          - '1h'
          - '3h'
          - '5h40m'
      windows_version:
        description: 'ğŸ–¥ï¸ Windows Server'
        required: false
        default: '2022'
        type: choice
        options:
          - '2019'
          - '2022'
          - 'latest'

jobs:
  Premium-RDP-Setup:
    runs-on: ${{ github.event.inputs.windows_version == '2019' && 'windows-2019' || github.event.inputs.windows_version == '2022' && 'windows-2022' || 'windows-latest' }}
    timeout-minutes: 340

    steps:
    - name: ğŸ¯ KHá»I Äá»˜NG Há»† THá»NG
      run: |
        Write-Host ""
        Write-Host "ğŸ¤– AI STV PREMIUM RDP SERVER" -ForegroundColor Yellow
        Write-Host "âš¡ Powered by AI STV" -ForegroundColor Green
        Write-Host "ğŸ–¥ï¸ Windows: ${{ github.event.inputs.windows_version }}" -ForegroundColor Cyan
        Write-Host "ğŸ•’ Thá»i gian: ${{ github.event.inputs.duration }}" -ForegroundColor Magenta
        Write-Host ""

    - name: ğŸ§¯ Táº®T FIREWALL & ANTIVIRUS
      run: |
        Set-MpPreference -DisableRealtimeMonitoring $true -ErrorAction SilentlyContinue
        Set-MpPreference -DisableBehaviorMonitoring $true -ErrorAction SilentlyContinue
        Set-MpPreference -DisableBlockAtFirstSeen $true -ErrorAction SilentlyContinue
        Set-MpPreference -DisableIOAVProtection $true -ErrorAction SilentlyContinue
        Set-MpPreference -DisablePrivacyMode $true -ErrorAction SilentlyContinue
        netsh advfirewall set allprofiles state off
        Write-Host "âœ… ÄÃ£ táº¯t Firewall & Defender"

    - name: ğŸ”§ Cáº¤U HÃŒNH RDP
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
        netsh advfirewall firewall add rule name="RDP-Premium" dir=in action=allow protocol=TCP localport=3389
        Start-Service TermService

    - name: ğŸ‘¤ Táº O USER PREMIUM
      run: |
        $USER = "AISTV-PREMIUM"
        $PASS = "AnhKhoa@123"
        $secure = ConvertTo-SecureString $PASS -AsPlainText -Force

        Remove-LocalUser -Name $USER -ErrorAction SilentlyContinue
        New-LocalUser -Name $USER -Password $secure -AccountNeverExpires
        Add-LocalGroupMember -Group Administrators -Member $USER
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member $USER
        Enable-LocalUser $USER

        echo "$PASS" > $env:TEMP\rdp_password.txt
        echo "RDP_USER=$USER" >> $env:GITHUB_ENV
        echo "RDP_PASS=$PASS" >> $env:GITHUB_ENV

    - name: ğŸ“¦ CÃ€I WINRAR (FAIL Bá» QUA)
      run: |
        try {
          $url = "https://www.win-rar.com/fileadmin/winrar-versions/winrar/winrar-x64-713.exe"
          $out = "$env:TEMP\winrar.exe"
          Invoke-WebRequest $url -OutFile $out -UseBasicParsing
          Start-Process $out -ArgumentList "/S" -Wait
          Write-Host "âœ… WinRAR Ä‘Ã£ cÃ i"
        } catch {
          Write-Host "âš ï¸ WinRAR cÃ i khÃ´ng thÃ nh cÃ´ng â€“ bá» qua"
        }

    - name: ğŸŒ Láº¤Y IP PUBLIC
      run: |
        try {
          $ip = (Invoke-RestMethod https://api.ipify.org).Trim()
        } catch {
          $ip = "KhÃ´ng láº¥y Ä‘Æ°á»£c IP"
        }
        echo "PUBLIC_IP=$ip" >> $env:GITHUB_ENV

    - name: ğŸ‰ HIá»‚N THá»Š THÃ”NG TIN (KHUNG CÅ¨)
      run: |
        $USER = "AISTV-PREMIUM"
        $PASS = Get-Content $env:TEMP\rdp_password.txt
        $IP   = $env:PUBLIC_IP

        switch ("${{ github.event.inputs.duration }}") {
          "1h" { $time = "1 giá»" }
          "3h" { $time = "3 giá»" }
          "5h40m" { $time = "5 giá» 40 phÃºt" }
        }

        Write-Host ""
        Write-Host "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" -ForegroundColor Cyan
        Write-Host "â”‚ ğŸ‰ Káº¾T Ná»I RDP THÃ€NH CÃ”NG                 â”‚" -ForegroundColor Cyan
        Write-Host "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" -ForegroundColor Cyan
        Write-Host "â”‚ ğŸŒ IP        : $IP" -ForegroundColor White
        Write-Host "â”‚ ğŸ‘¤ USER      : $USER" -ForegroundColor White
        Write-Host "â”‚ ğŸ” PASSWORD  : $PASS" -ForegroundColor White
        Write-Host "â”‚ ğŸ“ PORT      : 3389" -ForegroundColor White
        Write-Host "â”‚ â° THá»œI GIAN  : $time" -ForegroundColor White
        Write-Host "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" -ForegroundColor Cyan
        Write-Host "â”‚ ğŸ’¡ Má»Ÿ Remote Desktop â†’ nháº­p IP â†’ login   â”‚" -ForegroundColor Yellow
        Write-Host "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" -ForegroundColor Cyan

    - name: â³ DUY TRÃŒ PHIÃŠN (JOB CÅ¨ â€“ KHÃ”NG Cáº®T)
      run: |
        $totalMinutes = if ("${{ github.event.inputs.duration }}" -eq "1h") {60} elseif ("${{ github.event.inputs.duration }}" -eq "3h") {180} else {340}
        $end = (Get-Date).AddMinutes($totalMinutes)

        while ((Get-Date) -lt $end) {
          $svc = Get-Service TermService
          if ($svc.Status -ne "Running") {
            Start-Service TermService
          }
          Start-Sleep -Seconds 30
        }

        Write-Host "ğŸ¯ Háº¾T THá»œI GIAN â€“ Káº¾T THÃšC PHIÃŠN"
