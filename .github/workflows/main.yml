name: ğŸš€ SEVER AI STV PREMIUM

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ğŸ• Thá»i gian sá»­ dá»¥ng'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h'
        - '5h40m'
        - '6h'
        - '12h'

jobs:
  Banner:
    runs-on: windows-2022
    steps:
      - name: ğŸ¯ KHá»I Äá»˜NG Há»† THá»NG
        run: |
          Write-Host ""
          Write-Host ""
          Write-Host "ğŸ¤– AI STV PREMIUM RDP SERVER" -ForegroundColor Yellow
          Write-Host "âš¡ Powered by AI STV" -ForegroundColor Green
          Write-Host "ğŸ•’ Thá»i gian: ${{ github.event.inputs.duration }}" -ForegroundColor Magenta
          Write-Host ""
          $frames = @('â£¾','â£½','â£»','â¢¿','â¡¿','â£Ÿ','â£¯','â£·')
          for($i=0; $i -lt 10; $i++){
              Write-Host "`rğŸš€ Äang khá»Ÿi táº¡o há»‡ thá»‘ng... $($frames[$i % 8])" -NoNewline -ForegroundColor Blue
              Start-Sleep -Milliseconds 100
          }
          Write-Host "`râœ… Há»‡ thá»‘ng Ä‘Ã£ sáºµn sÃ ng!                    " -ForegroundColor Green

  Configure-System:
    runs-on: windows-latest
    steps:
      - name: ğŸ”§ Cáº¤U HÃŒNH Há»† THá»NG
        run: |
          Write-Host ""
          Write-Host "ğŸ› ï¸  ÄANG Cáº¤U HÃŒNH Há»† THá»NG" -ForegroundColor Yellow
          $steps = @(
              @{Name="Báº­t Remote Desktop"; Script={ Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force }},
              @{Name="Táº¯t xÃ¡c thá»±c máº¡ng"; Script={ Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force }},
              @{Name="Cáº¥u hÃ¬nh báº£o máº­t RDP"; Script={ Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
                Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force }},
              @{Name="Má»Ÿ port 3389 firewall"; Script={ netsh advfirewall firewall add rule name="RDP-Premium" dir=in action=allow protocol=TCP localport=3389 profile=any
                netsh advfirewall firewall add rule name="RDP-Premium-Out" dir=out action=allow protocol=TCP localport=3389 profile=any }},
              @{Name="Khá»Ÿi Ä‘á»™ng dá»‹ch vá»¥"; Script={ Set-Service -Name TermService -StartupType Automatic -ErrorAction SilentlyContinue
                Set-Service -Name UmRdpService -StartupType Automatic -ErrorAction SilentlyContinue
                Start-Service -Name TermService -ErrorAction SilentlyContinue
                Start-Service -Name UmRdpService -ErrorAction SilentlyContinue }}
          )
          foreach($step in $steps){
              Write-Host "â”‚ ğŸ“‹ $($step.Name)..." -NoNewline -ForegroundColor White
              try{ & $step.Script; Write-Host "`râ”‚ âœ… $($step.Name)" -ForegroundColor Green } 
              catch{ Write-Host "`râ”‚ âš ï¸  $($step.Name) - ÄÃ£ bá» qua lá»—i nhá»" -ForegroundColor Yellow }
              Start-Sleep -Milliseconds 500
          }
          Write-Host "ğŸ¯ Cáº¥u hÃ¬nh hoÃ n táº¥t!" -ForegroundColor Green

  Create-User:
    runs-on: windows-latest
    steps:
      - name: ğŸ‘¤ Táº O TÃ€I KHOáº¢N PREMIUM
        run: |
          Write-Host ""
          Write-Host "ğŸ‘¤ ÄANG Táº O TÃ€I KHOáº¢N PREMIUM" -ForegroundColor Yellow

          $matKhau = "AnhKhoa"
          $securePass = ConvertTo-SecureString $matKhau -AsPlainText -Force

          try{ Remove-LocalUser -Name "AISTV-PREMIUM" -ErrorAction SilentlyContinue; Write-Host "â”‚ âœ… ÄÃ£ xÃ³a user cÅ©" -ForegroundColor Green } 
          catch{ Write-Host "â”‚ â„¹ï¸ KhÃ´ng cÃ³ user cÅ© Ä‘á»ƒ xÃ³a" -ForegroundColor Blue }

          try{
            New-LocalUser -Name "AISTV-PREMIUM" -Password $securePass -AccountNeverExpires -Description "AI STV Premium Account"
            Set-LocalUser -Name "AISTV-PREMIUM" -PasswordNeverExpires $true -ErrorAction SilentlyContinue
            Add-LocalGroupMember -Group "Administrators" -Member "AISTV-PREMIUM" -ErrorAction SilentlyContinue
            Add-LocalGroupMember -Group "Remote Desktop Users" -Member "AISTV-PREMIUM" -ErrorAction SilentlyContinue
            Add-LocalGroupMember -Group "Users" -Member "AISTV-PREMIUM" -ErrorAction SilentlyContinue
            Enable-LocalUser -Name "AISTV-PREMIUM"
            Write-Host "â”‚ âœ… ÄÃ£ cáº¥p quyá»n Administrator & RDP" -ForegroundColor Green
          } catch { Write-Host "â”‚ âŒ Lá»—i táº¡o user: $($_.Exception.Message)" -ForegroundColor Red; exit 1 }

          echo "RDP_USER=AISTV-PREMIUM" >> $env:GITHUB_ENV
          echo "RDP_PASS=$matKhau" >> $env:GITHUB_ENV
          echo "$matKhau" > $env:TEMP\rdp_password.txt
          Write-Host "âœ… TÃ i khoáº£n: AISTV-PREMIUM Ä‘Ã£ sáºµn sÃ ng" -ForegroundColor Green

  Tailscale:
    runs-on: windows-latest
    env:
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
    steps:
      - name: ğŸŒ THIáº¾T Láº¬P Máº NG PREMIUM
        run: |
          Write-Host ""
          Write-Host "ğŸŒ ÄANG THIáº¾T Láº¬P Káº¾T Ná»I Máº NG" -ForegroundColor Yellow

          # CÃ i Tailscale
          try{
            $msiPath = "$env:TEMP\tailscale-premium.msi"
            Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msiPath
            Start-Process msiexec.exe -ArgumentList "/i", "`"$msiPath`"", "/quiet", "/norestart" -Wait
            Remove-Item $msiPath -Force -ErrorAction SilentlyContinue
            Write-Host "â”‚ âœ… CÃ i Ä‘áº·t Tailscale thÃ nh cÃ´ng" -ForegroundColor Green
          } catch{ Write-Host "â”‚ âŒ Lá»—i cÃ i Ä‘áº·t Tailscale" -ForegroundColor Red }

          Start-Sleep -Seconds 10

          try{
            & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=ai-stv-premium-$env:GITHUB_RUN_ID --accept-routes --accept-dns --reset
            Write-Host "â”‚ âœ… Káº¿t ná»‘i Tailscale thÃ nh cÃ´ng" -ForegroundColor Green
          } catch{ Write-Host "â”‚ âŒ Lá»—i káº¿t ná»‘i Tailscale" -ForegroundColor Red }

          # Láº¥y IP
          Write-Host "ğŸ”„ Äang láº¥y Ä‘á»‹a chá»‰ IP..." -NoNewline -ForegroundColor Blue
          $ip = $null
          for($i=0; $i -lt 20; $i++){
              try{
                $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>&1
                if($ip -and $ip -match '^\d+\.\d+\.\d+\.\d+$'){
                  echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
                  Write-Host "`râœ… Äá»‹a chá»‰ IP: $ip" -ForegroundColor Green
                  break
                }
              } catch { }
              Write-Host "`rğŸ”„ Äang láº¥y Ä‘á»‹a chá»‰ IP... $(@('.', '..', '...')[$i % 3])" -NoNewline -ForegroundColor Blue
              Start-Sleep -Seconds 3
          }
          if(-not $ip -or $ip -notmatch '^\d+\.\d+\.\d+\.\d+$'){
            Write-Host "`râš ï¸ KhÃ´ng thá»ƒ láº¥y IP, sá»­ dá»¥ng localhost" -ForegroundColor Yellow
            echo "TAILSCALE_IP=localhost" >> $env:GITHUB_ENV
          }

  Display-Info:
    runs-on: windows-latest
    steps:
      - name: ğŸ‰ THÃ”NG TIN Káº¾T Ná»I
        run: |
          $matKhau = Get-Content $env:TEMP\rdp_password.txt -ErrorAction SilentlyContinue
          if(-not $matKhau){ $matKhau = "KhÃ´ng thá»ƒ Ä‘á»c máº­t kháº©u" }
          $durationInput = "${{ github.event.inputs.duration }}"
          switch ($durationInput){
              "1h"{ $totalMinutes=60; $displayTime="1 giá»" }
              "3h"{ $totalMinutes=180; $displayTime="3 giá»" }
              "5h40m"{ $totalMinutes=340; $displayTime="5 giá» 40 phÃºt" }
              "6h"{ $totalMinutes=360; $displayTime="6 giá»" }
              "12h"{ $totalMinutes=720; $displayTime="12 giá»" }
          }
          $timeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
          $thoiGianBatDau = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
          $thoiGianKetThuc = $thoiGianBatDau.AddMinutes($totalMinutes)
          Write-Host ""
          Write-Host "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" -ForegroundColor Cyan
          Write-Host "â”‚ ğŸ‰ Káº¾T Ná»I THÃ€NH CÃ”NG! â”‚" -ForegroundColor Cyan
          Write-Host "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" -ForegroundColor Cyan
          Write-Host "â”‚ ğŸŒ Äá»‹a chá»‰: $env:TAILSCALE_IP" -ForegroundColor White
          Write-Host "â”‚ ğŸ‘¤ TÃ i khoáº£n: AISTV-PREMIUM" -ForegroundColor White
          Write-Host "â”‚ ğŸ” Máº­t kháº©u: $matKhau" -ForegroundColor White
          Write-Host "â”‚ â° Thá»i lÆ°á»£ng: $displayTime" -ForegroundColor White
          Write-Host "â”‚ ğŸ• Báº¯t Ä‘áº§u: $($thoiGianBatDau.ToString('HH:mm:ss'))" -ForegroundColor White
          Write-Host "â”‚ ğŸ• Káº¿t thÃºc: $($thoiGianKetThuc.ToString('HH:mm:ss'))" -ForegroundColor White
          Write-Host "â”‚ ğŸ“ Port: 3389" -ForegroundColor White
          Write-Host "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" -ForegroundColor Cyan

  Maintain-Session:
    runs-on: windows-latest
    steps:
      - name: â³ DUY TRÃŒ PHIÃŠN LÃ€M VIá»†C
        run: |
          $matKhau = Get-Content $env:TEMP\rdp_password.txt -ErrorAction SilentlyContinue
          $totalMinutes = $env:TOTAL_MINUTES
          $timeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
          $thoiGianBatDau = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
          $thoiGianKetThuc = $thoiGianBatDau.AddMinutes($totalMinutes)
          Write-Host ""
          Write-Host "ğŸ”„ Báº®T Äáº¦U DUY TRÃŒ PHIÃŠN LÃ€M VIá»†C..." -ForegroundColor Yellow
          Write-Host "ğŸ’ PhiÃªn: AI STV PREMIUM" -ForegroundColor Magenta
          Write-Host "ğŸ”— Káº¿t ná»‘i: $env:TAILSCALE_IP" -ForegroundColor Cyan
          Write-Host "ğŸ• Báº¯t Ä‘áº§u: $($thoiGianBatDau.ToString('HH:mm:ss'))" -ForegroundColor Green
          Write-Host "ğŸ• Káº¿t thÃºc: $($thoiGianKetThuc.ToString('HH:mm:ss'))" -ForegroundColor Green
          Write-Host ""

          # Monitor TermService & RDP connections
          $monitorScript = {
            $lastLogTime = Get-Date
            while($true){
              $currentTime = Get-Date
              if(($currentTime - $lastLogTime).TotalMinutes -ge 2){
                $termService = Get-Service -Name TermService -ErrorAction SilentlyContinue
                $rdpConnections = Get-NetTCPConnection -LocalPort 3389 -ErrorAction SilentlyContinue | Where-Object {$_.State -eq 'Established'}
                Write-Host "[$($currentTime.ToString('HH:mm:ss'))] ğŸ“Š Tráº¡ng thÃ¡i - RDP: $($termService.Status), Káº¿t ná»‘i: $($rdpConnections.Count)" -
