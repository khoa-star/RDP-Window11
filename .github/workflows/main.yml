name: ğŸš€ SEVER AI STV PREMIUM

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ğŸ• Thá»i gian sá»­ dá»¥ng'
        required: false
        default: '5h40m'
        type: choice
        options:
          - '1h'
          - '3h'
          - '5h40m'
      server_version:
        description: 'Chá»n phiÃªn báº£n Windows Server'
        required: false
        default: '2022'
        type: choice
        options:
          - '2019'
          - '2022'
          - 'latest'

jobs:
  Premium-RDP-Setup:
    runs-on: windows-2022
    timeout-minutes: 340
    steps:
      - name: ğŸ¯ KHá»I Äá»˜NG Há»† THá»NG
        run: |
          Write-Host ""
          Write-Host "ğŸ¤– AI STV PREMIUM RDP SERVER" -ForegroundColor Yellow
          Write-Host "âš¡ Powered by AI STV" -ForegroundColor Green
          Write-Host "ğŸ•’ Thá»i gian: ${{ github.event.inputs.duration }}" -ForegroundColor Magenta
          $frames = @('â£¾','â£½','â£»','â¢¿','â¡¿','â£Ÿ','â£¯','â£·')
          for($i=0;$i -lt 10;$i++){
            Write-Host "`rğŸš€ Äang khá»Ÿi táº¡o há»‡ thá»‘ng... $($frames[$i % 8])" -NoNewline -ForegroundColor Blue
            Start-Sleep -Milliseconds 100
          }
          Write-Host "`râœ… Há»‡ thá»‘ng Ä‘Ã£ sáºµn sÃ ng!" -ForegroundColor Green

      - name: ğŸ”§ Cáº¤U HÃŒNH Há»† THá»NG
        run: |
          Write-Host "ğŸ› ï¸ ÄANG Cáº¤U HÃŒNH Há»† THá»NG" -ForegroundColor Yellow
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP-Premium" dir=in action=allow protocol=TCP localport=3389 profile=any
          netsh advfirewall firewall add rule name="RDP-Premium-Out" dir=out action=allow protocol=TCP localport=3389 profile=any
          Set-Service -Name TermService -StartupType Automatic -ErrorAction SilentlyContinue
          Set-Service -Name UmRdpService -StartupType Automatic -ErrorAction SilentlyContinue
          Start-Service -Name TermService -ErrorAction SilentlyContinue
          Start-Service -Name UmRdpService -ErrorAction SilentlyContinue

      - name: ğŸ‘¤ Táº O TÃ€I KHOáº¢N PREMIUM
        run: |
          Write-Host "ğŸ‘¤ ÄANG Táº O TÃ€I KHOáº¢N PREMIUM" -ForegroundColor Yellow
          $matKhau="AnhKhoa@123"
          $securePass=ConvertTo-SecureString $matKhau -AsPlainText -Force
          try { Remove-LocalUser -Name "AISTV-PREMIUM" -ErrorAction SilentlyContinue } catch {}
          New-LocalUser -Name "AISTV-PREMIUM" -Password $securePass -AccountNeverExpires -Description "AI STV Premium Account"
          Set-LocalUser -Name "AISTV-PREMIUM" -PasswordNeverExpires $true -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Administrators" -Member "AISTV-PREMIUM" -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "AISTV-PREMIUM" -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Users" -Member "AISTV-PREMIUM" -ErrorAction SilentlyContinue
          Enable-LocalUser -Name "AISTV-PREMIUM"

      - name: ğŸ–¥ï¸ HIá»‚N THá»Š THÃ”NG TIN Káº¾T Ná»I
        run: |
          $matKhau="AnhKhoa@123"
          $tailIP="Äang láº¥y..."
          Write-Host ""
          Write-Host "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" -ForegroundColor Cyan
          Write-Host "â”‚ ğŸŒ IP: ________________" -ForegroundColor White
          Write-Host "â”‚ ğŸ‘¤ User: ________________" -ForegroundColor White
          Write-Host "â”‚ ğŸ” Pass: ________________" -ForegroundColor White
          Write-Host "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" -ForegroundColor Cyan
          Write-Host "â”‚ â„¹ï¸ LÆ°u Ã½: Sau khi káº¿t ná»‘i RDP, sá»­ dá»¥ng User/Pass á»Ÿ trÃªn" -ForegroundColor Yellow

      - name: ğŸ—œï¸ CÃ€I WINRAR
        run: |
          Write-Host "ğŸ”„ CÃ i WinRAR náº¿u chÆ°a cÃ³..." -ForegroundColor Yellow
          $winrarPath="$env:ProgramFiles\WinRAR\WinRAR.exe"
          if (-Not (Test-Path $winrarPath)) {
            $installer="$env:TEMP\winrar-x64.exe"
            try {
              Invoke-WebRequest -Uri "https://www.win-rar.com/fileadmin/winrar-versions/winrar/winrar-x64-713.exe" -OutFile $installer
              Start-Process -FilePath $installer -ArgumentList "/S" -Wait
              Write-Host "âœ… WinRAR Ä‘Ã£ cÃ i xong" -ForegroundColor Green
            } catch {
              Write-Host "âš ï¸ KhÃ´ng thá»ƒ cÃ i WinRAR, bá» qua" -ForegroundColor Yellow
            } finally {
              Remove-Item $installer -ErrorAction SilentlyContinue
            }
          } else {
            Write-Host "âœ… WinRAR Ä‘Ã£ cÃ³ sáºµn" -ForegroundColor Green
          }

      - name: â³ DUY TRÃŒ PHIÃŠN LÃ€M VIá»†C
        run: |
          Write-Host "ğŸ”„ Báº®T Äáº¦U DUY TRÃŒ PHIÃŠN LÃ€M VIá»†C..." -ForegroundColor Yellow
          $lastLogTime=Get-Date
          while($true){
            $termService=Get-Service -Name TermService -ErrorAction SilentlyContinue
            if($termService.Status -ne 'Running'){Start-Service -Name TermService -ErrorAction SilentlyContinue}
            Start-Sleep -Seconds 30
          }

      - name: ğŸ§¹ Dá»ŒN Dáº¸P Há»† THá»NG
        if: always()
        run: |
          Write-Host "ğŸ§¹ ÄANG Dá»ŒN Dáº¸P Há»† THá»NG..." -ForegroundColor Yellow
          Remove-Item "$env:TEMP\rdp_password.txt" -ErrorAction SilentlyContinue
          Disable-LocalUser -Name "AISTV-PREMIUM" -ErrorAction SilentlyContinue
          netsh advfirewall firewall delete rule name="RDP-Premium" dir=in -ErrorAction SilentlyContinue
          netsh advfirewall firewall delete rule name="RDP-Premium-Out" dir=out -ErrorAction SilentlyContinue
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 1 -Force
          Stop-Service -Name TermService -Force -ErrorAction SilentlyContinue
