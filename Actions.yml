name: üöÄ SEVER AI STV PREMIUM

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'üïê Th·ªùi gian s·ª≠ d·ª•ng'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h'
        - '5h40m'
        - '6h'
        - '12h'

jobs:
  Premium-RDP-Setup:
    runs-on: windows-2022
    timeout-minutes: 720
    
    steps:
      # BANNER CH√ÄO M·ª™NG
      - name: üéØ KH·ªûI ƒê·ªòNG H·ªÜ TH·ªêNG
        run: |
          Write-Host ""
          Write-Host ""
          Write-Host "ü§ñ AI STV PREMIUM RDP SERVER" -ForegroundColor Yellow
          Write-Host "‚ö° Powered by AI STV" -ForegroundColor Green
          Write-Host "üïí Th·ªùi gian: ${{ github.event.inputs.duration }}" -ForegroundColor Magenta
          Write-Host ""
          
          # Hi·ªáu ·ª©ng loading
          $frames = @('‚£æ', '‚£Ω', '‚£ª', '‚¢ø', '‚°ø', '‚£ü', '‚£Ø', '‚£∑')
          for($i=0; $i -lt 10; $i++) {
              Write-Host "`rüöÄ ƒêang kh·ªüi t·∫°o h·ªá th·ªëng... $($frames[$i % 8])" -NoNewline -ForegroundColor Blue
              Start-Sleep -Milliseconds 100
          }
          Write-Host "`r‚úÖ H·ªá th·ªëng ƒë√£ s·∫µn s√†ng!                    " -ForegroundColor Green

      # C·∫§U H√åNH N√ÇNG CAO
      - name: üîß C·∫§U H√åNH H·ªÜ TH·ªêNG
        run: |
          Write-Host ""
          Write-Host "üõ†Ô∏è  ƒêANG C·∫§U H√åNH H·ªÜ TH·ªêNG" -ForegroundColor Yellow
          
          $steps = @(
              @{Name="B·∫≠t Remote Desktop"; Script={ 
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
              }},
              @{Name="T·∫Øt x√°c th·ª±c m·∫°ng"; Script={
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
              }},
              @{Name="C·∫•u h√¨nh b·∫£o m·∫≠t RDP"; Script={
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
              }},
              @{Name="M·ªü port 3389 firewall"; Script={
                  netsh advfirewall firewall add rule name="RDP-Premium" dir=in action=allow protocol=TCP localport=3389 profile=any
                  netsh advfirewall firewall add rule name="RDP-Premium-Out" dir=out action=allow protocol=TCP localport=3389 profile=any
              }},
              @{Name="Kh·ªüi ƒë·ªông d·ªãch v·ª•"; Script={
                  Set-Service -Name TermService -StartupType Automatic -ErrorAction SilentlyContinue
                  Set-Service -Name UmRdpService -StartupType Automatic -ErrorAction SilentlyContinue
                  Start-Service -Name TermService -ErrorAction SilentlyContinue
                  Start-Service -Name UmRdpService -ErrorAction SilentlyContinue
              }}
          )
          
          foreach($step in $steps) {
              Write-Host "‚îÇ üìã $($step.Name)..." -NoNewline -ForegroundColor White
              try {
                  & $step.Script
                  Write-Host "`r‚îÇ ‚úÖ $($step.Name)" -ForegroundColor Green
              } catch {
                  Write-Host "`r‚îÇ ‚ö†Ô∏è  $($step.Name) - ƒê√£ b·ªè qua l·ªói nh·ªè" -ForegroundColor Yellow
              }
              Start-Sleep -Milliseconds 500
          }
          
          Write-Host "üéØ C·∫•u h√¨nh ho√†n t·∫•t!" -ForegroundColor Green

      # T·∫†O USER PREMIUM - m·∫≠t kh·∫©u c·ªë ƒë·ªãnh
      - name: üë§ T·∫†O T√ÄI KHO·∫¢N PREMIUM
        run: |
          Write-Host ""
          Write-Host "üë§ ƒêANG T·∫†O T√ÄI KHO·∫¢N PREMIUM" -ForegroundColor Yellow

          $matKhau = "AnhKhoa"
          $securePass = ConvertTo-SecureString $matKhau -AsPlainText -Force

          try { Remove-LocalUser -Name "AISTV-PREMIUM" -ErrorAction SilentlyContinue } catch {}
          try { New-LocalUser -Name "AISTV-PREMIUM" -Password $securePass -AccountNeverExpires -Description "AI STV Premium Account" } catch {}
          try { Set-LocalUser -Name "AISTV-PREMIUM" -PasswordNeverExpires $true -ErrorAction SilentlyContinue } catch {}
          try { Add-LocalGroupMember -Group "Administrators" -Member "AISTV-PREMIUM" -ErrorAction SilentlyContinue } catch {}
          try { Add-LocalGroupMember -Group "Remote Desktop Users" -Member "AISTV-PREMIUM" -ErrorAction SilentlyContinue } catch {}
          try { Enable-LocalUser -Name "AISTV-PREMIUM" } catch {}

          echo "$matKhau" > $env:TEMP\rdp_password.txt
          Write-Host "‚úÖ T√†i kho·∫£n: AISTV-PREMIUM ƒë√£ s·∫µn s√†ng" -ForegroundColor Green

      # TAILSCALE PREMIUM
      - name: üåê THI·∫æT L·∫¨P M·∫†NG PREMIUM
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          Write-Host ""
          Write-Host "üåê ƒêANG THI·∫æT L·∫¨P K·∫æT N·ªêI M·∫†NG" -ForegroundColor Yellow

          try {
              $msiPath = "$env:TEMP\tailscale-premium.msi"
              Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msiPath
              Start-Process msiexec.exe -ArgumentList "/i", "`"$msiPath`"", "/quiet", "/norestart" -Wait
              Remove-Item $msiPath -Force -ErrorAction SilentlyContinue
          } catch {}

          Start-Sleep -Seconds 10

          try {
              & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=ai-stv-premium-$env:GITHUB_RUN_ID --accept-routes --accept-dns --reset
          } catch {}

          $ip = $null
          for($i=0; $i -lt 20; $i++) {
              try {
                  $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>&1
                  if ($ip -and $ip -match '^\d+\.\d+\.\d+\.\d+$') {
                      echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
                      break
                  }
              } catch {}
              Start-Sleep -Seconds 3
          }
          if (-not $ip) { echo "TAILSCALE_IP=localhost" >> $env:GITHUB_ENV }

      # HI·ªÇN TH·ªä TH√îNG TIN
      - name: üéâ TH√îNG TIN K·∫æT N·ªêI
        run: |
          $matKhau = Get-Content $env:TEMP\rdp_password.txt -ErrorAction SilentlyContinue
          if (-not $matKhau) { $matKhau = "Kh√¥ng th·ªÉ ƒë·ªçc m·∫≠t kh·∫©u" }
          Write-Host "üåê IP: $env:TAILSCALE_IP" -ForegroundColor Cyan
          Write-Host "üë§ User: AISTV-PREMIUM" -ForegroundColor White
          Write-Host "üîë Pass: $matKhau" -ForegroundColor White
          Write-Host "üìç Port: 3389" -ForegroundColor White

      # DUY TR√å PHI√äN L√ÄM VI·ªÜC
      - name: ‚è≥ DUY TR√å PHI√äN L√ÄM VI·ªÜC
        run: |
          $totalMinutes = switch ("${{ github.event.inputs.duration }}") {
              "1h" { 60 }
              "3h" { 180 }
              "5h40m" { 340 }
              "6h" { 360 }
              "12h" { 720 }
          }
          $timeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
          $thoiGianBatDau = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
          $thoiGianKetThuc = $thoiGianBatDau.AddMinutes($totalMinutes)
          $monitorScript = { while ($true) { $termService = Get-Service -Name TermService -ErrorAction SilentlyContinue; if ($termService.Status -ne 'Running') { Start-Service -Name TermService -ErrorAction SilentlyContinue }; Start-Sleep -Seconds 30 } }
          Start-Job -ScriptBlock $monitorScript -Name "SystemMonitor"

      # D·ªåN D·∫∏P H·ªÜ TH·ªêNG
      - name: üßπ D·ªåN D·∫∏P H·ªÜ TH·ªêNG
        if: always()
        run: |
          $cleanupSteps = @(
              @{Name="X√≥a file password"; Script={ Remove-Item "$env:TEMP\rdp_password.txt" -ErrorAction SilentlyContinue }},
              @{Name="V√¥ hi·ªáu h√≥a user"; Script={ Disable-LocalUser -Name "AISTV-PREMIUM" -ErrorAction SilentlyContinue }},
              @{Name="ƒê√≥ng k·∫øt n·ªëi m·∫°ng"; Script={ & "$env:ProgramFiles\Tailscale\tailscale.exe" down --accept-risk=all -ErrorAction SilentlyContinue; Start-Sleep -Seconds 5 }},
              @{Name="X√≥a rule firewall"; Script={ netsh advfirewall firewall delete rule name="RDP-Premium" dir=in -ErrorAction SilentlyContinue; netsh advfirewall firewall delete rule name="RDP-Premium-Out" dir=out -ErrorAction SilentlyContinue }},
              @{Name="Kh√¥i ph·ª•c c√†i ƒë·∫∑t RDP"; Script={ Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 1 -Force; Stop-Service -Name TermService -Force -ErrorAction SilentlyContinue }}
          )
          foreach($step in $cleanupSteps) { try { & $step.Script } catch {} }
