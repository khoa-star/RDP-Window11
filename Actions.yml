name: üöÄ SEVER AI STV PREMIUM

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'üïê Th·ªùi gian s·ª≠ d·ª•ng'
        required: false
        default: '12h'
        type: choice
        options:
          - '1h'
          - '3h'
          - '6h'
          - '12h'

jobs:
  Premium-RDP-Setup:
    runs-on: windows-latest
    timeout-minutes: 720

    steps:
      # BANNER CH√ÄO M·ª™NG
      - name: üéØ KH·ªûI ƒê·ªòNG H·ªÜ TH·ªêNG
        run: |
          Write-Host ""
          Write-Host ""
          Write-Host "ü§ñ AI STV PREMIUM RDP SERVER" -ForegroundColor Yellow
          Write-Host "‚ö° Powered by AI STV" -ForegroundColor Green
          Write-Host "üïí Th·ªùi gian: ${{ github.event.inputs.duration }}" -ForegroundColor Magenta
          Write-Host ""
          $frames = @('‚£æ', '‚£Ω', '‚£ª', '‚¢ø', '‚°ø', '‚£ü', '‚£Ø', '‚£∑')
          for($i=0; $i -lt 10; $i++) {
            Write-Host "`rüöÄ ƒêang kh·ªüi t·∫°o h·ªá th·ªëng... $($frames[$i % 8])" -NoNewline -ForegroundColor Blue
            Start-Sleep -Milliseconds 100
          }
          Write-Host "`r‚úÖ H·ªá th·ªëng ƒë√£ s·∫µn s√†ng! " -ForegroundColor Green

      # T·∫ÆT ANTIVIRUS / FIREWALL
      - name: üõë T·∫ÆT WINDOWS SECURITY
        run: |
          Write-Host "üõë ƒêang t·∫Øt Windows Security, Firewall, SmartScreen..." -ForegroundColor Yellow
          reg add "HKLM\SOFTWARE\Microsoft\Windows Defender\Features" /v TamperProtection /t REG_DWORD /d 0 /f
          Set-MpPreference -DisableRealtimeMonitoring $true
          Set-MpPreference -DisableBehaviorMonitoring $true
          Set-MpPreference -DisableBlockAtFirstSeen $true
          Set-MpPreference -DisableIOAVProtection $true
          Set-MpPreference -DisableScriptScanning $true
          reg add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer" /v SmartScreenEnabled /t REG_SZ /d Off /f
          reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows\System" /v EnableSmartScreen /t REG_DWORD /d 0 /f
          reg add "HKLM\SOFTWARE\Microsoft\Windows Defender\SmartScreen" /v ConfigureAppInstallControlEnabled /t REG_DWORD /d 0 /f
          netsh advfirewall set allprofiles state off
          Write-Host "‚úÖ ƒê√£ t·∫Øt xong Windows Security & Firewall" -ForegroundColor Green

      # C·∫§U H√åNH RDP N√ÇNG CAO
      - name: üîß C·∫§U H√åNH H·ªÜ TH·ªêNG
        run: |
          Write-Host "" 
          Write-Host "üõ†Ô∏è ƒêANG C·∫§U H√åNH H·ªÜ TH·ªêNG" -ForegroundColor Yellow
          $steps = @(
            @{Name="B·∫≠t Remote Desktop"; Script={ Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force }},
            @{Name="T·∫Øt x√°c th·ª±c m·∫°ng"; Script={ Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force }},
            @{Name="C·∫•u h√¨nh b·∫£o m·∫≠t RDP"; Script={ Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force }},
            @{Name="M·ªü port 3389 firewall"; Script={ netsh advfirewall firewall add rule name="RDP-Premium" dir=in action=allow protocol=TCP localport=3389 profile=any; netsh advfirewall firewall add rule name="RDP-Premium-Out" dir=out action=allow protocol=TCP localport=3389 profile=any }},
            @{Name="Kh·ªüi ƒë·ªông d·ªãch v·ª•"; Script={ Set-Service -Name TermService -StartupType Automatic -ErrorAction SilentlyContinue; Set-Service -Name UmRdpService -StartupType Automatic -ErrorAction SilentlyContinue; Start-Service -Name TermService -ErrorAction SilentlyContinue; Start-Service -Name UmRdpService -ErrorAction SilentlyContinue }}
          )
          foreach($step in $steps) {
            Write-Host "‚îÇ üìã $($step.Name)..." -NoNewline -ForegroundColor White
            try { & $step.Script; Write-Host "`r‚îÇ ‚úÖ $($step.Name)" -ForegroundColor Green } 
            catch { Write-Host "`r‚îÇ ‚ö†Ô∏è $($step.Name) - ƒê√£ b·ªè qua l·ªói nh·ªè" -ForegroundColor Yellow }
            Start-Sleep -Milliseconds 500
          }
          Write-Host "üéØ C·∫•u h√¨nh ho√†n t·∫•t!" -ForegroundColor Green

      # T·∫†O USER PREMIUM (M·∫≠t kh·∫©u c·ªë ƒë·ªãnh)
      - name: üë§ T·∫†O T√ÄI KHO·∫¢N PREMIUM
        run: |
          Write-Host ""
          Write-Host "üë§ ƒêANG T·∫†O T√ÄI KHO·∫¢N PREMIUM" -ForegroundColor Yellow
          $Username = "AISTV-PREMIUM"
          $Password = "AnhKhoa@123"
          $securePass = ConvertTo-SecureString $Password -AsPlainText -Force

          try { Remove-LocalUser -Name $Username -ErrorAction SilentlyContinue; Write-Host "‚îÇ ‚úÖ ƒê√£ x√≥a user c≈©" -ForegroundColor Green } catch { Write-Host "‚îÇ ‚ÑπÔ∏è Kh√¥ng c√≥ user c≈© ƒë·ªÉ x√≥a" -ForegroundColor Blue }

          try {
            New-LocalUser -Name $Username -Password $securePass -AccountNeverExpires -Description "AI STV Premium Account"
            Set-LocalUser -Name $Username -PasswordNeverExpires $true -ErrorAction SilentlyContinue
            Add-LocalGroupMember -Group "Administrators" -Member $Username -ErrorAction SilentlyContinue
            Add-LocalGroupMember -Group "Remote Desktop Users" -Member $Username -ErrorAction SilentlyContinue
            Add-LocalGroupMember -Group "Users" -Member $Username -ErrorAction SilentlyContinue
            Enable-LocalUser -Name $Username
            Write-Host "‚îÇ ‚úÖ ƒê√£ c·∫•p quy·ªÅn Administrator & RDP" -ForegroundColor Green
          } catch { Write-Host "‚îÇ ‚ùå L·ªói t·∫°o user: $($_.Exception.Message)" -ForegroundColor Red; exit 1 }

          echo "RDP_USER=$Username" >> $env:GITHUB_ENV
          echo "RDP_PASS=$Password" >> $env:GITHUB_ENV
          echo "$Password" > $env:TEMP\rdp_password.txt
          Write-Host "‚úÖ T√†i kho·∫£n: $Username ƒë√£ s·∫µn s√†ng" -ForegroundColor Green

      # TAILSCALE PREMIUM & HI·ªÇN TH·ªä IP
      - name: üåê THI·∫æT L·∫¨P M·∫†NG PREMIUM
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          Write-Host "" 
          Write-Host "üåê ƒêANG THI·∫æT L·∫¨P K·∫æT N·ªêI M·∫†NG" -ForegroundColor Yellow
          $msiPath = "$env:TEMP\tailscale-premium.msi"
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msiPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$msiPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $msiPath -Force -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 10
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=ai-stv-premium-$env:GITHUB_RUN_ID --accept-routes --accept-dns --reset
          Write-Host "‚îÇ ‚úÖ K·∫øt n·ªëi Tailscale th√†nh c√¥ng" -ForegroundColor Green

          $ip = $null
          for($i=0; $i -lt 20; $i++) {
            try {
              $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>&1
              if ($ip -and $ip -match '^\d+\.\d+\.\d+\.\d+$') { echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV; Write-Host "`r‚úÖ ƒê·ªãa ch·ªâ IP: $ip" -ForegroundColor Green; break }
            } catch {}
            Write-Host "`rüîÑ ƒêang l·∫•y ƒë·ªãa ch·ªâ IP... $(@('.', '..', '...')[$i % 3])" -NoNewline -ForegroundColor Blue
            Start-Sleep -Seconds 3
          }
          if (-not $ip -or $ip -notmatch '^\d+\.\d+\.\d+\.\d+$') { Write-Host "`r‚ö†Ô∏è Kh√¥ng th·ªÉ l·∫•y IP, s·ª≠ d·ª•ng localhost" -ForegroundColor Yellow; echo "TAILSCALE_IP=localhost" >> $env:GITHUB_ENV }

      # DUY TR√å PHI√äN L√ÄM VI·ªÜC (Monitor + Timer)
      - name: ‚è≥ DUY TR√å PHI√äN L√ÄM VI·ªÜC
        run: |
          $matKhau = Get-Content $env:TEMP\rdp_password.txt -ErrorAction SilentlyContinue
          $durationInput = "${{ github.event.inputs.duration }}"
          switch ($durationInput) {
            "1h" { $totalMinutes = 60; $displayTime = "1 gi·ªù" }
            "3h" { $totalMinutes = 180; $displayTime = "3 gi·ªù" }
            "6h" { $totalMinutes = 360; $displayTime = "6 gi·ªù" }
            "12h" { $totalMinutes = 720; $displayTime = "12 gi·ªù" }
          }

          $timeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
          $thoiGianBatDau = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
          $thoiGianKetThuc = $thoiGianBatDau.AddMinutes($totalMinutes)

          Write-Host ""
          Write-Host "üîÑ B·∫ÆT ƒê·∫¶U DUY TR√å PHI√äN L√ÄM VI·ªÜC..." -ForegroundColor Yellow
          Write-Host "üíé Phi√™n: AI STV PREMIUM" -ForegroundColor Magenta
          Write-Host "üîó K·∫øt n·ªëi: $env:TAILSCALE_IP" -ForegroundColor Cyan
          Write-Host "üïê B·∫Øt ƒë·∫ßu: $($thoiGianBatDau.ToString('HH:mm:ss'))" -ForegroundColor Green
          Write-Host "üïê K·∫øt th√∫c: $($thoiGianKetThuc.ToString('HH:mm:ss'))" -ForegroundColor Green
          Write-Host ""

          $monitorScript = {
            $lastLogTime = Get-Date
            while ($true) {
              $currentTime = Get-Date
              if (($currentTime - $lastLogTime).TotalMinutes -ge 2) {
                $termService = Get-Service -Name TermService -ErrorAction SilentlyContinue
                $rdpConnections = Get-NetTCPConnection -LocalPort 3389 -ErrorAction SilentlyContinue | Where-Object {$_.State -eq 'Established'}
                Write-Host "[$($currentTime.ToString('HH:mm:ss'))] üìä Tr·∫°ng th√°i - RDP: $($termService.Status), K·∫øt n·ªëi: $($rdpConnections.Count)" -ForegroundColor Blue
                $lastLogTime = $currentTime
              }
              $termService = Get-Service -Name TermService -ErrorAction SilentlyContinue
              if ($termService.Status -ne 'Running') { Write-Host "[$($currentTime.ToString('HH:mm:ss'))] üîÑ Kh·ªüi ƒë·ªông l·∫°i TermService..." -ForegroundColor Yellow; Start-Service -Name TermService -ErrorAction SilentlyContinue }
              Start-Sleep -Seconds 30
            }
          }
          Start-Job -ScriptBlock $monitorScript -Name "SystemMonitor"

          $frames = @('‚†ã','‚†ô','‚†π','‚†∏','‚†º','‚†¥','‚†¶','‚†ß','‚†á','‚†è')
          $colors = @('Red','Yellow','Green','Cyan','Blue','Magenta')
          $startTime = Get-Date
          do {
            $thoiGianHienTai = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
            $thoiGianConLai = $thoiGianKetThuc - $thoiGianHienTai
            $gioConLai = [math]::Max(0, [math]::Floor($thoiGianConLai.TotalHours))
            $phutConLai = [math]::Max(0, [math]::Floor($thoiGianConLai.TotalMinutes % 60))
            $giayConLai = [math]::Max(0, [math]::Floor($thoiGianConLai.TotalSeconds % 60))
            $frame = $frames[([int]((Get-Date) - $startTime).TotalSeconds) % $frames.Length]
            $color = $colors[([int]((Get-Date) - $startTime).TotalMinutes) % $colors.Length]
            Write-Host "`r$frame [$($thoiGianHienTai.ToString('HH:mm:ss'))] Th·ªùi gian c√≤n l·∫°i: $gioConLai gi·ªù $phutConLai ph√∫t $giayConLai gi√¢y" -NoNewline -ForegroundColor $color
            Start-Sleep -Seconds 5
          } while ($thoiGianConLai.TotalSeconds -gt 0)

          Write-Host ""
          Write-Host "üéØ ƒê√É H·∫æT TH·ªúI GIAN - T·ª∞ ƒê·ªòNG D·ª™NG!" -ForegroundColor Red
          Get-Job -Name "SystemMonitor" -ErrorAction SilentlyContinue | Stop-Job -PassThru | Remove-Job -Force

      # D·ªåN D·∫∏P CU·ªêI
      - name: üßπ D·ªåN D·∫∏P H·ªÜ TH·ªêNG
        if: always()
        run: |
          Write-Host ""
          Write-Host "üßπ ƒêANG D·ªåN D·∫∏P H·ªÜ TH·ªêNG..." -ForegroundColor Yellow
          $cleanupSteps = @(
            @{Name="X√≥a file password"; Script={ Remove-Item "$env:TEMP\rdp_password.txt" -ErrorAction SilentlyContinue }},
            @{Name="V√¥ hi·ªáu h√≥a user"; Script={ Disable-LocalUser -Name "AISTV-PREMIUM" -ErrorAction SilentlyContinue }},
            @{Name="ƒê√≥ng k·∫øt n·ªëi m·∫°ng"; Script={ & "$env:ProgramFiles\Tailscale\tailscale.exe" down --accept-risk=all -ErrorAction SilentlyContinue; Start-Sleep -Seconds 5 }},
            @{Name="X√≥a rule firewall"; Script={ netsh advfirewall firewall delete rule name="RDP-Premium" dir=in -ErrorAction SilentlyContinue; netsh advfirewall firewall delete rule name="RDP-Premium-Out" dir=out -ErrorAction SilentlyContinue; Remove-NetFirewallRule -DisplayName "RDP-Premium" -ErrorAction SilentlyContinue; Remove-NetFirewallRule -DisplayName "RDP-Premium-Out" -ErrorAction SilentlyContinue }},
            @{Name="Kh√¥i ph·ª•c c√†i ƒë·∫∑t RDP"; Script={ Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 1 -Force -ErrorAction SilentlyContinue; Stop-Service -Name TermService -Force -ErrorAction SilentlyContinue }}
          )
          foreach($step in $cleanupSteps) {
            Write-Host "‚îÇ üóëÔ∏è $($step.Name)..." -NoNewline -ForegroundColor Gray
            try { & $step.Script; Write-Host "`r‚îÇ ‚úÖ $($step.Name)" -ForegroundColor Green } catch { Write-Host "`r‚îÇ ‚ö†Ô∏è $($step.Name) - ƒê√£ x·ª≠ l√Ω an to√†n" -ForegroundColor Yellow }
            Start-Sleep -Milliseconds 300
          }
          Get-Job | Stop-Job -PassThru | Remove-Job -Force -ErrorAction SilentlyContinue
          Write-Host ""
          Write-Host "üéâ D·ªçn d·∫πp ho√†n t·∫•t! H·∫πn g·∫∑p l·∫°i! üëã" -ForegroundColor Green
